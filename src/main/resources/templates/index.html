<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Query to JSON Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css">
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <style>
        .container { max-width: 1400px; }
        .monospace { font-family: 'Courier New', monospace; }
        .query-input { height: 200px; font-size: 14px; }
        .json-output { height: 400px; font-size: 14px; }
        .form-section { margin-bottom: 2rem; }
        .alert { margin-bottom: 1rem; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .table-sm td, .table-sm th { padding: 0.5rem; }
        .validation-item { border-left: 3px solid #0d6efd; padding-left: 10px; margin-bottom: 10px; }
        .dropdown-option-item { background-color: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        .required-field {
            background-color: #fff3cd !important;
            border-left: 3px solid #ffc107 !important;
        }

        .hidden-field {
            background-color: #f8f9fa !important;
            opacity: 0.7;
        }

        .required-field.hidden-field {
            background-color: #e9ecef !important;
            border-left: 3px solid #6c757d !important;
        }
        .saving { opacity: 0.6; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1055; }
        .field-setup-btn { min-width: 80px; }
        .validation-help-text {
            transition: all 0.3s ease;
            font-style: italic;
        }

        .validation-type option[style*="display: none"] {
            display: none !important;
        }

        .validation-row {
            border-left: 3px solid #e9ecef;
            padding-left: 10px;
            margin-bottom: 15px;
            align-items: end;
            transition: border-color 0.3s ease;
        }

        .validation-row:hover {
            border-left-color: #007bff;
        }

        .check-value-hidden {
            display: none !important;
        }

        /* Date input styling with calendar icon */
        .validation-check[placeholder="DD/MM/YYYY"] {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 16px;
            padding-right: 2.5rem;
        }

        /* Litepicker custom styling */
        .litepicker {
            z-index: 9999 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .litepicker .container__months {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
        }

        /* Number input styling */
        .validation-check[type="number"] {
            -moz-appearance: textfield; /* Hide arrows in Firefox */
        }

        .validation-check[type="number"]::-webkit-outer-spin-button,
        .validation-check[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Hide arrows in Webkit browsers */
            margin: 0;
        }

        /* Better alignment for number inputs */
        .validation-check[type="number"] {
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
<!-- Toast Notifications -->
<div class="toast-container">
    <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="successToastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    <div id="errorToast" class="toast align-items-center text-bg-danger border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="errorToastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- Field Setup Modal -->
<div class="modal fade" id="fieldSetupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Field Setup: <span id="fieldSetupTitle"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Basic Field Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-exclamation-circle text-info" title="Το όνομα του πεδίου από το Where Clause του Select"></i>
                            DB Parameter
                        </label>
                        <input type="text" class="form-control" id="fieldDbParam" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="fas fa-exclamation-circle text-info" title="Την τιμή από το Resource Bundle Properties αρχεία του project σας (π.χ. UIResourceBundle_el.properties στο ssp.efka.pensions module)"></i>
                            Title
                        </label>
                        <input type="text" class="form-control" id="fieldTitle">
                    </div>
                </div>

                <!-- Field Type and Flags -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">
                            <i class="fas fa-exclamation-circle text-info" title="Πως θα εμφανίζεται στο Dynamic Panel το πεδίο."></i>
                            Field Type
                        </label>
                        <select class="form-select" id="fieldType">
                            <option th:each="type : ${fieldTypes}"
                                    th:value="${type.type}"
                                    th:text="${type.type}"></option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check mt-4">
                            <input type="checkbox" class="form-check-input" id="fieldRequired">
                            <label class="form-check-label" for="fieldRequired">
                                Required
                                <i class="fas fa-exclamation-circle text-info" title="Έαν το πεδίο είναι απαραίτητο για να επιστρέψει το Query αποτελέσματα, τότε θα εμφανίζεται Bold στο Dynamic Panel."></i>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check mt-4">
                            <input type="checkbox" class="form-check-input" id="fieldHidden">
                            <label class="form-check-label" for="fieldHidden">
                                Hidden
                                <i class="fas fa-exclamation-circle text-info" title="Έαν το πεδίο δε θέλουμε να εμφανίζεται στο Dynamic Panel."></i>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Forms based on Field Type -->

                <!-- LOV Code (for LOV type) -->
                <div class="lov-specific" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="fas fa-exclamation-circle text-info" title="Τον κωδικό από την Lov που θα καλέσει, π.χ. L0002"></i>
                                LOV Code
                            </label>
                            <input type="text" class="form-control" id="fieldLovCode" placeholder="Enter LOV code. e.g. L0002">
                        </div>
                    </div>
                </div>

                <!-- Dropdown Options (for DROPDOWN type) -->
                <div class="dropdown-specific" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6>Dropdown Options</h6>
                            <div class="form-text">Τις επιλογές που θα εμφανίζονται στο Dropdown πεδίο.</div>
                            <div id="dropdownOptionsContainer">
                                <!-- Options will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addDropdownOption()">
                                Add Option
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Validations Section -->
                <div class="validations-section">
                    <h6>Validations</h6>
                    <div id="validationsContainer">
                        <!-- Validations will be loaded here -->
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addValidation()">
                        Add Validation
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFieldSetup()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="text-center"><i class="fas fa-database text-primary"></i> Oracle Query to JSON Converter</h1>
            <p class="text-center text-muted">Μετατροπή Oracle SELECT queries σε JSON configuration για search panels</p>
        </div>
    </div>

    <!-- Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:each="err : ${errors}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-times-circle"></i> <span th:text="${err}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:each="warning : ${warnings}" class="alert alert-warning alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle"></i> <span th:text="${warning}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Query Input Form -->
    <form th:if="${session.analysis == null or session.analysis.hasErrors()}" th:object="${queryInput}" th:action="@{/analyze}" method="post" class="form-section">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-code"></i> Εισαγωγή Query</h5>
                <span class="badge bg-light text-primary">Βήμα 1</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="panelTitle" class="form-label fw-bold">
                            <i class="fas fa-exclamation-circle text-info" title="Την τιμή από το Resource Bundle Properties αρχεία του project σας (π.χ. UIResourceBundle_el.properties στο ssp.efka.pensions module)"></i>
                            Τίτλος Panel:
                        </label>
                        <div class="form-text">Ο τίτλος που θα εμφανίζεται στο side panel</div>
                        <input type="text" th:field="*{panelTitle}" class="form-control"  required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="query" class="form-label fw-bold">Oracle SELECT Query:</label>
                    <div class="form-text">Εισάγετε το SQL query που θα χρησιμοποιηθεί στο <b>Lov_Query</b> columns</div>
                    <textarea th:field="*{query}" class="form-control query-input monospace"
                              placeholder="Εισάγετε το SELECT query εδώ..." required></textarea>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-search"></i> Ανάλυση Query
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- Results Section -->
    <div th:if="${session.analysis != null and !session.analysis.hasErrors()}" class="form-section">
        <!-- Προσθήκη κουμπιού καθαρισμού -->
        <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-outline-danger" onclick="clearAnalysis()">
                <i class="fas fa-trash"></i> Καθαρισμός Ανάλυσης
            </button>
        </div>

        <!-- Search Fields Configuration -->
        <div class="card border-info mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Ρύθμιση Search Fields</h5>
                <span class="badge bg-light text-info">Βήμα 2</span>
            </div>
            <div class="card-body">
                <!-- Search Fields Table -->
                <h6 class="fw-bold mb-3"><i class="fas fa-list"></i> Αναγνωρισμένα Search Fields από το Query</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Κάντε κλικ στο κουμπί "Setup" για να ρυθμίσετε όλες τις ιδιότητες κάθε field σε ένα ενιαίο modal.
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-sm table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th width="25%">Τίτλος</th>
                            <th width="20%">DB Parameter</th>
                            <th width="15%">Τύπος</th>
                            <th width="10%" class="text-center">Required</th>
                            <th width="10%" class="text-center">Hidden</th>
                            <th width="20%">Ενέργειες</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="field : ${session.analysis.searchFields}"
                            th:class="${field.required} ? 'required-field' : ''"
                            th:classappend="${field.hidden} ? 'hidden-field' : ''">
                            <td>
                                <span th:text="${field.title}" class="fw-bold"></span>
                                <div class="required-msg form-text text-xs" th:if="${field.required}">
                                    <i class="fas fa-exclamation-circle text-warning"></i> Required
                                </div>
                            </td>
                            <td>
                                <code th:text="${field.dbParam}"></code>
                            </td>
                            <td>
                                <span th:text="${field.type}" class="badge bg-secondary"></span>
                                <div class="form-text text-xs" th:if="${field.type == 'LOV' and field.lovCode}">
                                    LOV: <span th:text="${field.lovCode}"></span>
                                </div>
                                <div class="form-text text-xs" th:if="${field.type == 'DROPDOWN' and not field.dropdownOptions.empty}">
                                    Options: <span th:text="${field.dropdownOptions.size()}"></span>
                                </div>
                            </td>
                            <td class="text-center">
                                <i th:if="${field.required}" class="fas fa-check text-success"></i>
                                <i th:unless="${field.required}" class="fas fa-times text-muted"></i>
                            </td>
                            <td class="text-center">
                                <i th:if="${field.hidden}" class="fas fa-check text-success"></i>
                                <i th:unless="${field.hidden}" class="fas fa-times text-muted"></i>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary field-setup-btn"
                                        th:attr="onclick=|openFieldSetup('${field.dbParam}')|">
                                    <i class="fas fa-cog"></i> Setup
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Result Columns -->
        <div class="card border-success mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Ρύθμιση Result Columns</h5>
                <span class="badge bg-light text-success">Βήμα 3</span>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> Τα result columns προέρχονται από το SELECT clause του query.
                    Μπορείτε να τροποποιήσετε τον τίτλο κάθε column.
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-success">
                        <tr>
                            <th width="40%">Τίτλος Column</th>
                            <th width="40%">Name in Results</th>
                            <th width="20%" class="text-center">Ορατό</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="column : ${session.analysis.resultColumns}">
                            <td>
                                <input type="text" th:value="${column.title}" class="form-control form-control-sm column-title"
                                       th:attr="data-nameinresults=${column.nameInResults}"
                                       onchange="updateColumnTitle(this)"
                                       onblur="updateColumnTitle(this)">
                            </td>
                            <td>
                                <code th:text="${column.nameInResults}"></code>
                            </td>
                            <td class="text-center">
                                <input type="checkbox" th:checked="${column.visible}" class="form-check-input column-visible"
                                       th:attr="data-nameinresults=${column.nameInResults}"
                                       onchange="updateColumnVisible(this)">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Generate JSON -->
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-file-code"></i> JSON Output</h5>
                <span class="badge bg-light text-warning">Βήμα 4</span>
            </div>
            <div class="card-body">
                <form th:action="@{/generate-json}" method="post">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Τελικός Τίτλος Panel:</label>
                            <input type="text" name="panelTitle" th:value="${session.analysis.panelTitle}"
                                   class="form-control" required>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="fas fa-sync-alt"></i> Generate JSON
                        </button>
                    </div>
                </form>

                <div th:if="${generatedJson}">
                    <label class="form-label fw-bold">Generated JSON:</label>
                    <textarea class="form-control json-output monospace" readonly
                              th:text="${generatedJson}"></textarea>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button class="btn btn-info" onclick="copyToClipboard()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                        <button class="btn btn-success" onclick="downloadJson()">
                            <i class="fas fa-download"></i> Download JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global variables
    let currentField = null;
    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));

    // Toast notification functions
    function showSuccess(message) {
        document.getElementById('successToastMessage').textContent = message;
        successToast.show();
    }

    function showError(message) {
        document.getElementById('errorToastMessage').textContent = message;
        errorToast.show();
    }

    // Clear analysis function
    function clearAnalysis() {
        if (confirm('Είστε σίγουρος ότι θέλετε να καθαρίσετε την τρέχουσα ανάλυση; Όλες οι αλλαγές θα χαθούν.')) {
            fetch('/clear-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
                .then(response => {
                    if (response.redirected) {
                        // If server redirected, follow the redirect
                        window.location.href = response.url;
                    } else if (response.ok) {
                        showSuccess('Η ανάλυση καθαρίστηκε επιτυχώς!');
                        // Force complete page reload to reset everything
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1000);
                    } else {
                        throw new Error('Failed to clear analysis');
                    }
                })
                .catch(error => {
                    console.error('Error clearing analysis:', error);
                    showError('Σφάλμα κατά τον καθαρισμό της ανάλυσης');
                });
        }
    }

    // Field Setup Modal Functions
    function openFieldSetup(fieldDbParam) {
        // Get field data from server
        fetch('/api/search-fields/' + encodeURIComponent(fieldDbParam))
            .then(response => response.json())
            .then(field => {
                currentField = field;

                console.log('Field data received:', field);

                // Set basic field info
                document.getElementById('fieldSetupTitle').textContent = field.title;
                document.getElementById('fieldDbParam').value = field.dbParam;
                document.getElementById('fieldTitle').value = field.title;
                document.getElementById('fieldType').value = field.type.type;
                document.getElementById('fieldRequired').checked = field.required;
                document.getElementById('fieldHidden').checked = field.hidden;

                // Set LOV code if exists
                if (field.lovCode) {
                    document.getElementById('fieldLovCode').value = field.lovCode;
                }

                // Show/hide type-specific sections
                toggleFieldTypeSections(field.type);
                updateValidationTypesForType(field.type.type);

                // Load validations and dropdown options
                loadValidations(field);
                loadDropdownOptions(field);

                // Show modal
                new bootstrap.Modal(document.getElementById('fieldSetupModal')).show();

            })
            .catch(error => {
                console.error('Error loading field data:', error);
                showError('Error loading field data');
            });
    }

    // Toggle field type specific sections
    function toggleFieldTypeSections(fieldType) {
        const lovSection = document.querySelector('.lov-specific');
        const dropdownSection = document.querySelector('.dropdown-specific');

        // Hide all first
        lovSection.style.display = 'none';
        dropdownSection.style.display = 'none';

        // Show based on type
        if (fieldType.type === 'lov') {
            lovSection.style.display = 'block';
        } else if (fieldType.type === 'dropdown') {
            dropdownSection.style.display = 'block';
        }
    }

    function updateValidationTypesForType(fieldType, validationKey = '', currentValidationType = '') {
        console.log('Fetching validation types for field type:', fieldType, 'for key:', validationKey, 'with current:', currentValidationType);

        fetch(`/api/validation-types/${fieldType}?fieldDbParam=${encodeURIComponent(currentField?.dbParam)}`)
            .then(response => response.json())
            .then(data => {
                const validationTypes = data.validationTypes;
                const remainingFields = data.remainingFields;

                console.log('Received validation types objects:', validationTypes);

                // Find the specific validation select if we have a key, otherwise update all
                let validationSelects;
                if (validationKey) {
                    // Find the specific select for this validation key
                    const specificSelect = document.querySelector(`.validation-type[data-validation-key="${validationKey}"]`);
                    validationSelects = specificSelect ? [specificSelect] : [];
                } else {
                    // Update all validation dropdowns
                    validationSelects = document.querySelectorAll('.validation-type');
                }

                validationSelects.forEach(select => {
                    const currentValue = select.value;

                    // Clear existing options
                    select.innerHTML = '<option value="" disabled="disabled">Select Type</option>';

                    // Add new options
                    validationTypes.forEach(vtype => {
                        const option = document.createElement('option');
                        option.value = vtype.type;
                        option.textContent = vtype.label;
                        option.setAttribute('data-helptext', vtype.helpText);
                        option.setAttribute('data-checkValue', vtype.needsCheckValue);

                        // Store remaining fields for CLEAR validation
                        if (vtype.type === 'clear' && remainingFields) {
                            option.setAttribute('data-remaining-fields', remainingFields);
                        }

                        // Set selected if it matches the current validation type for this specific row
                        if (vtype.type === currentValidationType.toLowerCase()) {
                            option.selected = true;
                        }

                        select.appendChild(option);
                    });

                    // If no currentValidationType was set, try to keep the current value
                    if (!currentValidationType && currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }

                    onValidationTypeChange(select);
                });
            })
            .catch(error => {
                console.error('Error fetching validation types:', error);
                showError('Error loading validation types');
            });
    }

    // Load validations
    function loadValidations(field) {
        const container = document.getElementById('validationsContainer');
        container.innerHTML = '';

        if (field.validations && Object.keys(field.validations).length > 0) {
            Object.entries(field.validations).forEach(([key, validation]) => {
                addValidationRow(key, validation);
            });
        }
    }

    // Load dropdown options
    function loadDropdownOptions(field) {
        const container = document.getElementById('dropdownOptionsContainer');
        container.innerHTML = '';

        if (field.dropdownOptions && field.dropdownOptions.length > 0) {
            field.dropdownOptions.forEach((option, index) => {
                addDropdownOptionRow(index, option);
            });
        }
    }

    // Add validation row
    function addValidation() {
        addValidationRow('validation_' + Date.now(), { type: '', check: '', error: 'sidepanel.error.X', onSelectValidation: false });
    }

    function addValidationRow(key, validation) {
        const container = document.getElementById('validationsContainer');
        const row = document.createElement('div');
        row.className = 'validation-row row mb-3';
        row.innerHTML = `
        <div class="validation-help-text form-text small text-muted mt-1" style="min-height: 20px;"></div>
        <div class="col-md-3">
            <label class="form-label">Type</label>
            <select class="form-select validation-type" data-validation-key="${key}" onchange="onValidationTypeChange(this)">
                <option value="" disabled="disabled">Select Type</option>
                <!-- Options will be loaded dynamically -->
            </select>
        </div>
        <div class="col-md-3 check-value">
            <label class="form-label">
                <i class="fas fa-exclamation-circle text-info" title="Ποια τιμή/regex θα χρησιμοποιηθεί κατά τον έλεγχο"></i>
                Check Value
            </label>
            <input type="text" class="form-control validation-check" placeholder="Check value" value="${validation.check || ''}">
        </div>
        <div class="col-md-3">
            <label class="form-label">
                <i class="fas fa-exclamation-circle text-info" title="Την τιμή από το Resource Bundle Properties αρχεία του project σας (π.χ. UIResourceBundle_el.properties στο ssp.efka.pensions module)"></i>
                Error Message
            </label>
            <input type="text" class="form-control validation-error" placeholder="Error message" value="${validation.error || 'sidepanel.error.X'}">
        </div>
        <div class="col-md-2" hidden="hidden">
            <label class="form-label">On Select</label>
            <input type="checkbox" class="form-check-input validation-on-select" ${validation.onSelectValidation ? 'checked' : ''}>
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeValidationRow(this)">×</button>
        </div>
    `;

        container.appendChild(row);

        // Store the validation type for this specific row
        row.setAttribute('data-validation-type', validation.type || '');

        // Load validation types with the current validation type for THIS specific row
        const fieldType = document.getElementById('fieldType').value;
        updateValidationTypesForType(fieldType, key, validation.type);
    }

    function onValidationTypeChange(selectElement) {
        if (selectElement.selectedIndex === -1) {
            return;
        }
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const helpText = selectedOption.getAttribute('data-helptext') || '';
        const needsCheckValue = selectedOption.getAttribute('data-checkValue') === 'true';
        const validationType = selectElement.value;
        const remainingFields = selectedOption.getAttribute('data-remaining-fields');

        // Update help text
        const helpTextElement = selectElement.parentElement.parentElement.querySelector('.validation-help-text');
        if (helpTextElement) {
            helpTextElement.textContent = helpText;
            helpTextElement.style.color = helpText ? '#6c757d' : 'transparent';
        }

        // Update check value visibility
        const checkValueContainer = selectElement.closest('.validation-row').querySelector('.check-value');
        const checkInput = checkValueContainer.querySelector('.validation-check');

        if (checkValueContainer) {
            if (needsCheckValue) {
                checkValueContainer.classList.remove('check-value-hidden');

                // Auto-fill check value for CLEAR validation
                if (validationType === 'clear' && remainingFields && !checkInput.value) {
                    checkInput.value = remainingFields;
                } else {
                    checkInput.value = checkInput.getAttribute('value') || '';
                }

                if (validationType.toLowerCase() === 'min_date' || validationType.toLowerCase() === 'max_date') {
                    // Change to date input
                    checkInput.type = 'text';
                    checkInput.placeholder = 'DD/MM/YYYY';

                    // Initialize LitePick with Greek format
                    initializeDatePicker(checkInput);
                } else if (validationType === 'min_length' || validationType === 'max_length') {
                    // Use number input for length validations
                    checkInput.type = 'number';
                    checkInput.placeholder = 'Αριθμός χαρακτήρων';
                    checkInput.min = '0';
                    checkInput.step = '1';

                    // Destroy existing date picker if any
                    if (checkInput._litePicker) {
                        checkInput._litePicker.destroy();
                        checkInput._litePicker = null;
                    }

                } else {
                    // Change back to normal text input for other validations
                    checkInput.type = 'text';
                    checkInput.placeholder = 'Check value';

                    // Destroy existing date picker if any
                    if (checkInput._litePicker) {
                        checkInput._litePicker.destroy();
                        checkInput._litePicker = null;
                    }
                }
            } else {
                checkValueContainer.classList.add('check-value-hidden');
                checkInput.value = '';

                // Destroy date picker if it exists
                if (checkInput._litePicker) {
                    checkInput._litePicker.destroy();
                    checkInput._litePicker = null;
                }
            }
        }
    }

    // Initialize date picker with DD/MM/YYYY format
    function initializeDatePicker(inputElement) {
        // Destroy existing date picker if any
        if (inputElement._litePicker) {
            inputElement._litePicker.destroy();
        }

        // Get current value if it exists
        const currentValue = inputElement.getAttribute('value');

        const picker = new Litepicker({
            element: inputElement,
            format: 'DD/MM/YYYY',
            autoApply: true,
            dropdowns: {
                minYear: 1900,
                maxYear: new Date().getFullYear() + 2000,
                months: true,
                years: true
            },
            buttonText: {
                apply: 'Επιλογή',
                cancel: 'Ακύρωση'
            },
            lang: 'el-GR', // Greek language
            setup: (picker) => {
                // Set initial value if it exists
                if (currentValue && currentValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const parts = currentValue.split('/');
                    const date = new Date(parts[2], parts[1] - 1, parts[0]);
                    picker.setDate(date);
                }

                picker.on('selected', (date1, date2) => {
                    // Ensure the format is exactly DD/MM/YYYY
                    const formattedDate = date1 ? `${String(date1.getDate()).padStart(2, '0')}/${String(date1.getMonth() + 1).padStart(2, '0')}/${date1.getFullYear()}` : '';
                    // inputElement.value = formattedDate;
                    inputElement.setAttribute('value', formattedDate);
                });
            }
        });

        // Store reference to destroy later
        inputElement._litePicker = picker;
    }

    // Add dropdown option row
    function addDropdownOption() {
        addDropdownOptionRow(Date.now(), { label: '', value: '' });
    }

    function addDropdownOptionRow(key, option) {
        const container = document.getElementById('dropdownOptionsContainer');
        const row = document.createElement('div');
        row.className = 'dropdown-option-row row mb-2';
        row.innerHTML = `
            <div class="col-md-5">
                <label class="form-label">
                    <i class="fas fa-exclamation-circle text-info" title="Την τιμή από το Resource Bundle Properties αρχεία του project σας (π.χ. UIResourceBundle_el.properties στο ssp.efka.pensions module)"></i>
                    Label
                </label>
                <input type="text" class="form-control option-label" placeholder="Label" value="${option.label || 'sidepanel.label.X'}">
            </div>
            <div class="col-md-5">
                <label class="form-label">
                    <i class="fas fa-exclamation-circle text-info" title="Την τιμή που σετάρετε στον κώδικα"></i>
                    Value
                </label>
                <input type="text" class="form-control option-value" placeholder="Value" value="${option.value || ''}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDropdownOptionRow(this)">×</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Remove validation row
    function removeValidationRow(button) {
        button.closest('.validation-row').remove();
    }

    // Remove dropdown option row
    function removeDropdownOptionRow(button) {
        button.closest('.dropdown-option-row').remove();
    }

    // Save field setup
    function saveFieldSetup() {
        if (!currentField) {
            showError('No field selected');
            return;
        }

        // Collect all field data
        const fieldData = {
            title: document.getElementById('fieldTitle').value,
            type: document.getElementById('fieldType').value,
            required: document.getElementById('fieldRequired').checked,
            hidden: document.getElementById('fieldHidden').checked,
            lovCode: document.getElementById('fieldLovCode').value || '',
            validations: {},
            dropdownOptions: []
        };

        // Collect validations
        const validationRows = document.querySelectorAll('#validationsContainer .validation-row');
        validationRows.forEach(row => {
            const typeSelect = row.querySelector('.validation-type');
            const checkInput = row.querySelector('.validation-check');
            const errorInput = row.querySelector('.validation-error');
            const onSelectCheckbox = row.querySelector('.validation-on-select');

            if (typeSelect.value) {
                const key = 'validation_' + Date.now() + Math.random().toString(36).substr(2, 9);

                fieldData.validations[key] = {
                    type: typeSelect.value,
                    check: checkInput.value || '',
                    error: errorInput.value || '',
                    onSelectValidation: onSelectCheckbox?.checked || false
                };
            }
        });

        // Collect dropdown options
        const optionRows = document.querySelectorAll('#dropdownOptionsContainer .dropdown-option-row');
        optionRows.forEach(row => {
            const labelInput = row.querySelector('.option-label');
            const valueInput = row.querySelector('.option-value');

            if (labelInput.value && valueInput.value) {
                fieldData.dropdownOptions.push({
                    label: labelInput.value,
                    value: valueInput.value
                });
            }
        });

        console.log('Saving field data:', fieldData);

        // Send to server
        fetch(`/api/search-fields/update?dbParam=${encodeURIComponent(currentField.dbParam)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(fieldData)
        })
            .then(response => response.text())
            .then(result => {
                if (result === 'OK') {
                    showSuccess('Field updated successfully!');
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('fieldSetupModal')).hide();
                    // Update the UI without refreshing the page
                    updateFieldInTable(currentField.dbParam, fieldData);
                } else {
                    showError('Error updating field: ' + result);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error updating field: ' + error.message);
            });
    }

    // Function to update the field in the table without page refresh
    // Function to update the field in the table without page refresh
    function updateFieldInTable(fieldDbParam, fieldData) {
        // Find the table row for this field
        const tableRows = document.querySelectorAll('tbody tr');
        tableRows.forEach(row => {
            const dbParamCell = row.querySelector('code');
            if (dbParamCell && dbParamCell.textContent === fieldDbParam) {
                // Update title
                const titleCell = row.querySelector('.fw-bold');
                if (titleCell) {
                    titleCell.textContent = fieldData.title;
                }

                // Update required message
                let requiredMsg = row.querySelector('.required-msg');
                if (fieldData.required) {
                    if (!requiredMsg) {
                        // Create required message if it doesn't exist
                        requiredMsg = document.createElement('div');
                        requiredMsg.className = 'required-msg form-text text-xs';
                        requiredMsg.innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i> Required';
                        titleCell.parentNode.appendChild(requiredMsg);
                    } else {
                        // Show existing required message
                        requiredMsg.style.display = 'block';
                    }
                } else {
                    // Hide required message
                    if (requiredMsg) {
                        requiredMsg.style.display = 'none';
                    }
                }

                // Update type badge
                const typeBadge = row.querySelector('.badge');
                if (typeBadge) {
                    typeBadge.textContent = fieldData.type;
                }

                // Update required indicator
                const requiredIcon = row.querySelector('td:nth-child(4) i');
                if (requiredIcon) {
                    if (fieldData.required) {
                        requiredIcon.className = 'fas fa-check text-success';
                    } else {
                        requiredIcon.className = 'fas fa-times text-muted';
                    }
                }

                // Update hidden indicator
                const hiddenIcon = row.querySelector('td:nth-child(5) i');
                if (hiddenIcon) {
                    if (fieldData.hidden) {
                        hiddenIcon.className = 'fas fa-check text-success';
                    } else {
                        hiddenIcon.className = 'fas fa-times text-muted';
                    }
                }

                // Update row styling
                if (fieldData.required) {
                    row.classList.add('required-field');
                } else {
                    row.classList.remove('required-field');
                }

                if (fieldData.hidden) {
                    row.classList.add('hidden-field');
                } else {
                    row.classList.remove('hidden-field');
                }

                // Update LOV/Dropdown info
                const typeInfoDiv = row.querySelector('td:nth-child(3) .form-text.text-xs');
                if (typeInfoDiv) {
                    if (fieldData.type === 'lov' && fieldData.lovCode) {
                        typeInfoDiv.innerHTML = `LOV: <span>${fieldData.lovCode}</span>`;
                        typeInfoDiv.style.display = 'block';
                    } else if (fieldData.type === 'dropdown' && fieldData.dropdownOptions.length > 0) {
                        typeInfoDiv.innerHTML = `Options: <span>${fieldData.dropdownOptions.length}</span>`;
                        typeInfoDiv.style.display = 'block';
                    } else {
                        typeInfoDiv.style.display = 'none';
                    }
                }
            }
        });
    }

    // Column update functions
    function updateColumnTitle(input) {
        const nameInResults = input.getAttribute('data-nameinresults');
        const title = input.value;

        showSavingIndicator(input);

        fetch('/api/result-columns/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `nameInResults=${encodeURIComponent(nameInResults)}&title=${encodeURIComponent(title)}`
        })
            .then(response => response.text())
            .then(result => {
                hideSavingIndicator(input);
                if (result === 'OK') {
                    showSuccess('Column title updated successfully!');
                } else {
                    showError('Error updating column title: ' + result);
                }
            })
            .catch(error => {
                hideSavingIndicator(input);
                console.error('Error:', error);
                showError('Error updating column title');
            });
    }

    function updateColumnVisible(checkbox) {
        const nameInResults = checkbox.getAttribute('data-nameinresults');
        const visible = checkbox.checked;

        showSavingIndicator(checkbox);

        fetch('/api/result-columns/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `nameInResults=${encodeURIComponent(nameInResults)}&visible=${visible}`
        })
            .then(response => response.text())
            .then(result => {
                hideSavingIndicator(checkbox);
                if (result === 'OK') {
                    showSuccess('Column visibility updated successfully!');
                } else {
                    showError('Error updating column visibility: ' + result);
                }
            })
            .catch(error => {
                hideSavingIndicator(checkbox);
                console.error('Error:', error);
                showError('Error updating column visibility');
            });
    }

    // Utility functions
    function showSavingIndicator(element) {
        element.classList.add('saving');
    }

    function hideSavingIndicator(element) {
        element.classList.remove('saving');
    }

    function copyToClipboard() {
        const jsonTextarea = document.querySelector('.json-output');
        jsonTextarea.select();
        document.execCommand('copy');
        showSuccess('JSON copied to clipboard!');
    }

    function downloadJson() {
        const jsonContent = document.querySelector('.json-output').value;
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'panel-config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccess('JSON downloaded successfully!');
    }

    // Listen for field type changes
    document.getElementById('fieldType').addEventListener('change', function() {
        const fieldType = { type: this.value };
        toggleFieldTypeSections(fieldType);
        updateValidationTypesForType(this.value);
    });
</script>
</body>
</html>